clear all
close all
clc

format short 

disp('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%')
disp('%%    [Robótica - 23/10/2018 ~ 11/11/2018] LABWORK#2 - PROBLEMA 1    %%')
disp('%%                                                                   %%')
disp('%%                   Frederico Vaz, nº 2011283029                    %%')
disp('%%                   Paulo Almeida, nº 2010128473                    %%')
disp('%%                                                                   %%')
disp('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%')
disp(' ')

%% Robô 3-DOF: L1 = 4; L2 = 3 e L3 = 2

syms theta1 theta2 theta3

% a) Matriz dos parâmetros de Denavith-Hartenberg: PJ_DH

% Cumprimentos dos elos
L1 = 4; L2 = 3; L3 = 2;
% Junta Rotacional ou Prismática
R = 1; P = 0;

%          thetai   di    ai   alfai  offseti  jointtypei       
PJ_DH = [  theta1    0    L1       0        0           R;   % Junta Rotacional
           theta2    0    L2       0        0           R;   % Junta Rotacional
           theta3    0     0    pi/2     pi/2           R;   % Junta Rotacional  
                0   L3     0       0     pi/2           R ]; % Gripper Fixo


% A cinemática directa até ao Gripper
[ T0_G, Ti ] = MGD_DH(PJ_DH);  


% Criar Links Juntas Rotacionais -> o theta é variável
for i=1:4
    L(i) = Link('d',eval(PJ_DH(i,2)), 'a', eval(PJ_DH(i,3)), ...
           'alpha', eval(PJ_DH(i,4)), 'offset', eval(PJ_DH(i,5)));
end

robot = SerialLink(L, 'name', 'Robô Planar 3-DOF RRR');
robot_T0_2 = SerialLink(L(1:2));


%% b) Matrizes de Cinemática Directa de 0 A 2 e 0 A H;  c) Confirmação

% 3 casos de valores nas juntas para o Robô Planar 3-DOF - Gripper é fixo
q = [ deg2rad(0)  deg2rad(0)  deg2rad(0); 
      deg2rad(10) deg2rad(20) deg2rad(30);
      deg2rad(90) deg2rad(90) deg2rad(90) ];
  
% i) ii) iii)
for i=1:3
    
    T0_1 = eval(subs(Ti(:,:,1), q(i,1))); 
    T1_2 = eval(subs(Ti(:,:,2), q(i,2))); 
    T2_I = eval(subs(Ti(:,:,3), q(i,3))); 
    TI_H = Ti(:,:,4);    
   
    A0_2(:,:,i) = T0_1 * T1_2;
    A0_H(:,:,i) = eval( T0_1 * T1_2 * T2_I * TI_H );
    
    
    % c) Confirmação das Matrizes usando a toolbox Robotics
    T02(:,:,i) = robot_T0_2.fkine(q(i,1:2));
    T0H(:,:,i) = robot.fkine([q(i,:) 0]);
    
end



%% d) e) Solução da Cinemática Inversa 

% Matriz simbólica do Mundo ao Braço: O T 2
T0_1 = Ti(:,:,1);
T1_2 = Ti(:,:,2);

T0_2 = simplify( T0_1 * T1_2 );


% P/ os conjuntos das juntas da alínea anterior:
for i=1:3
    
    [q(i,:), q_(i,:)] = inverse_kinematics_ex2(A0_H(:,:,i));
    
end

% Confirmação usando a toolbox Robotics
for i=1:2

    q_tool(i,:) = robot.ikine(A0_H(:,:,i), 'mask', [1 1 0 1 0 1]);
    %NO
end


% disp('--------------------------------------------------------------------')
% %% Estamos aqui com um erro!
% % ConfirmaÃ§Ã£o da CinemÃ¡tica Inversa pela toolbox Robotics
% disp(' ')
% disp('CinemÃ¡tica Inversa pela toolbox Robotics:')
% 
% for i=1:3
%    
%     q__(i,:) = robot.ikine(A0H(:,:,i), [0 0 0 0]) % [1 1 0 1 1 0]
%     disp('')
%     disp(['q' num2str(i) ' = [ ' num2str(rad2deg(q__(i,1))) 'Âº ' num2str(rad2deg(q__(i,2))) 'Âº ' num2str(rad2deg(q__(i,3))) 'Âº ]'])
%     disp(' ')
% end
% disp(' ')
% disp('########################################################################')



%% MENU ("main")

% Variaveis MENU
select = 0;
STOP = 9;

while(select ~= STOP)
    
    select = menu('Seleccione a acao a realizar:', 'a) Matriz PJ_DH e O T G',...
                                                   'b) c) q = [ 0º  0º  0º]',...
                                                   'b) c) q = [10º 20º 30º]',...
                                                   'b) c) q = [90º 90º 90º]',...
                                                   'Robot q = [ 0º  0º  0º]',...
                                                   'Robot q = [10º 20º 30º]',...
                                                   'Robot q = [90º 90º 90º]',...
                                                   'Cinemática Inversa',...
                                                   'Quit');  
                                                
    % a) Matriz dos parametros de Denavith-Hartenberg: PJ_DH
    if select == 1  
        disp('______________________________________________________________________')
        disp(' ')
        disp('a) Matriz dos parâmetros de Denavith-Hartenberg: PJ_DH')
        disp('______________________________________________________________________')
        disp(' ')
        robot.display
        disp(' ')
        disp('______________________________________________________________________')
        disp(' ')
        disp('a) Cinemática Directa: O T G')
        disp('______________________________________________________________________')
        disp(' ')
        disp(T0_G)
        disp(' ')
        disp('______________________________________________________________________')
    disp('#######################################################################')   
    end  
    
    % b) Matrizes de Cinemática Directa de 0 A 2 e 0 A H
    if select == 2 || select == 3 || select == 4
        
        i = select - 1;
        
        disp(' ')
        disp(['q' num2str(i) ' = [ ' num2str(rad2deg(q(i,1))) 'º ' num2str(rad2deg(q(i,2))) 'º ' num2str(rad2deg(q(i,3))) 'º ]'])
        disp(' ')
        disp('A02:')
        disp(' ')
        disp(A0_2(:,:,i))
        disp(' ')
        disp('c) Confirmação usando a toolbox Robotics:')
        disp(' ')
        disp(T02(:,:,i))
        disp('______________________________________________________________________') 
        disp(' ')
        disp('A0H:')
        disp(' ')
        disp(A0_H(:,:,i))
        disp(' ')
        disp('c) Confirmação usando a toolbox Robotics:')
        disp(' ')
        disp(double(T0H(:,:,i)))
        disp(' ')
        disp('______________________________________________________________________')   
    end

    % Representação gráfica dos Robôs
    if select == 5 || select == 6 || select == 7
        
        i = select - 4;
        
        figure('units','normalized','outerposition',[0 0 1 1]);
        % Prespectiva de topo do Robot -------------------------------------
        robot.plot([q(i,:) 0], 'workspace', [-15 15 -2 10 -2 2],...
                   'reach', 1,...
                   'scale', 1,...
                   'zoom', 0.25,...
                   'view',...
                   'top');
         
    end
    
    % Cinemática Inversa
    if select == 8
        disp('d) e) Solução de Cinemática Inversa ')
        disp(' ')

        disp('Matriz simbólica do Mundo ao Gripper: O T G')
        disp(' ')
        disp(T0_G)
        disp(' ')
        disp('Matriz simbólica do Mundo ao Braço: O T 2')
        disp(' ')
        disp(T0_2)
        disp(' ')
        disp('______________________________________________________________________')   

        % Conjuntos das juntas para cada caso da alínea anterior:
        disp(' ')
        disp('Conjunto de soluções: ')
        
        for i=1:3
            disp([num2str(i) ')'])
            disp(' ')
            disp('Caso positivo')
            disp(['q' num2str(i) ' = [ ' num2str(rad2deg(q(i,1))) 'º ' num2str(rad2deg(q(i,2))) 'º ' num2str(rad2deg(q(i,3))) 'º ]'])
            disp(' ')

            disp('Caso negativo:')
            disp(['q' num2str(i) ' = [ ' num2str(rad2deg(q_(i,1))) 'º ' num2str(rad2deg(q_(i,2))) 'º ' num2str(rad2deg(q_(i,3))) 'º ]'])
            disp(' ')
            disp(' ')
            disp('c) Confirmação usando a toolbox Robotics:')
            disp(' ')
            
            disp('______________________________________________________________________')   
        end
    end
    
    % clear workspace
    if select == STOP
       close all; 
    end
    
end













